trigger:
- main

pool:
  vmImage: ubuntu-latest

steps:
# 1. Exchange the OIDC token
# We still need this to "activate" the OIDC handshake for the job
- task: JfrogCliV2@1
  name: jfAuth
  inputs:
    jfrogPlatformConnection: 'serviceconnection'
    command: 'jf rt ping'

# 2. Use the token via the global environment variable
- bash: |
    echo "Starting OIDC-authenticated download..."
    
    # The JFrog extension automatically sets this global variable 
    # for all subsequent steps in the job.
    TOKEN=$JFROG_PLATFORM_ACCESS_TOKEN
    
    echo "Token Length: ${#TOKEN}"

    if [ ${#TOKEN} -lt 100 ]; then
      echo "ERROR: Token exchange failed. Length is too short."
      exit 1
    fi

    # Using -fL to follow redirects and fail on 401
    curl -fL -H "Authorization: Bearer $TOKEN" \
         "https://hts2.jfrog.io/artifactory/sharanya-oidc/1mb.zip" \
         -o "1mb.zip"

    echo "Download finished successfully."
    ls -lh 1mb.zip
  displayName: 'OIDC Curl Download'
  env:
    # This is the standard variable name populated by the JFrog extension
    JFROG_PLATFORM_ACCESS_TOKEN: $(JFROG_PLATFORM_ACCESS_TOKEN)