trigger:
- main

pool:
  vmImage: ubuntu-latest

steps:
# 1. Exchange the OIDC token.
# We name the task 'jfAuth' so we can reference its specific outputs.
- task: JfrogCliV2@1
  name: jfAuth
  inputs:
    jfrogPlatformConnection: 'serviceconnection'
    command: 'jf rt ping' 

# 2. Use a direct curl with the CORRECT token mapping.
- bash: |
    echo "Retrieving OIDC Token..."
    
    # Check if the token is present
    if [ -z "$MY_TOKEN" ]; then
      echo "ERROR: Token variable is empty. OIDC handshake failed."
      exit 1
    fi

    echo "Token detected. Length: ${#MY_TOKEN}"

    # OIDC requires the 'Authorization: Bearer' header
    # We use -f to fail the task if the server returns 401
    curl -fL -H "Authorization: Bearer $MY_TOKEN" \
         "https://hts2.jfrog.io/artifactory/sharanya-oidc/1mb.zip" \
         -o "1mb.zip"

    echo "Success! File downloaded."
    ls -lh 1mb.zip
  displayName: 'OIDC Curl Download'
  env:
    # Try mapping the task's specific output variable
    # If this doesn't work, we'll try $(JFROG_PLATFORM_ACCESS_TOKEN)
    MY_TOKEN: $(jfAuth.oidc_token)