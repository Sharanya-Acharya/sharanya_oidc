trigger:
- main

pool:
  vmImage: ubuntu-latest

steps:
# 1. Handshake: This task MUST be named 'jfAuth'
- task: JfrogCliV2@1
  name: jfAuth
  inputs:
    jfrogPlatformConnection: 'serviceconnection'
    command: 'jf rt ping' 

# 2. The Download Step
- bash: |
    echo "Checking OIDC Token..."
    
    # If this prints '0', your Service Connection/Identity Mapping is broken
    echo "Token Length: ${#TOKEN}"
    
    if [ -z "$TOKEN" ]; then
      echo "ERROR: No token found. Check if OIDC is enabled on your Service Connection."
      exit 1
    fi

    echo "Running curl download..."
    # -f fails the script on 401/404
    # -v shows the headers (use only for debugging)
    curl -fL -H "Authorization: Bearer $TOKEN" \
         "https://hts2.jfrog.io/artifactory/sharanya-oidc/1mb.zip" \
         -o "1mb.zip"

    echo "Download success!"
    ls -lh 1mb.zip
  displayName: 'OIDC Curl Download'
  env:
    # Use the specific output variable for OIDC tokens
    TOKEN: $(jfAuth.oidc_token)