trigger:
- main

pool:
  vmImage: ubuntu-latest

steps:
# 1. We name this task 'jfAuth'
- task: JfrogCliV2@1
  name: jfAuth
  inputs:
    jfrogPlatformConnection: 'serviceconnection'
    command: 'jf rt ping' # This triggers the OIDC exchange

# 2. We use a special script to extract the token the task just used
- bash: |
    echo "Retrieving OIDC Token..."
    
    # In recent versions of the extension, the token is stored in the 
    # environment variable JFROG_PLATFORM_ACCESS_TOKEN by the previous task.
    # We map it to OIDC_TOKEN in the 'env' section below.

    echo "Token Length: ${#OIDC_TOKEN}"
    
    if [ ${#OIDC_TOKEN} -lt 100 ]; then
      echo "ERROR: Token is too short (Length: ${#OIDC_TOKEN}). Exchange failed."
      exit 1
    fi

    curl -fL -H "Authorization: Bearer $OIDC_TOKEN" \
         "https://hts2.jfrog.io/artifactory/sharanya-oidc/1mb.zip" \
         -o "1mb.zip"

    echo "Download success!"
    ls -lh 1mb.zip
  displayName: 'OIDC Curl Download'
  env:
    # Use the GLOBAL variable provided by the JFrog extension
    OIDC_TOKEN: $(JFROG_PLATFORM_ACCESS_TOKEN)