trigger:
- main

pool:
  vmImage: ubuntu-latest

steps:
# 1. This task handles the OIDC handshake from your guide automatically.
# No need to write manual curl exchanges for the Azure token!
- task: JfrogCliV2@1
  name: jfAuth
  inputs:
    jfrogPlatformConnection: 'serviceconnection' # Ensure this connection is set to OIDC in project settings
    command: 'jf rt ping' 

# 2. Now use the token the task just generated in your curl command.
- bash: |
    echo "Starting download using OIDC-exchanged token..."
    
    # We use the variable we mapped in the 'env' section below.
    # This matches the 'Authorization: Bearer' format from your Rovo guide.
    curl -fL -H "Authorization: Bearer $MY_TOKEN" \
         "https://hts2.jfrog.io/artifactory/sharanya-oidc/1mb.zip" \
         -o "1mb.zip"

    if [ -s 1mb.zip ]; then
        echo "SUCCESS: 1mb.zip downloaded."
        ls -lh 1mb.zip
    else
        echo "ERROR: Download failed. Check JFrog Identity Mapping."
        exit 1
    fi
  displayName: 'OIDC Download via Curl'
  env:
    # This is the "secret sauce": the task exports 'oidc_token' after the exchange.
    MY_TOKEN: $(jfAuth.oidc_token)