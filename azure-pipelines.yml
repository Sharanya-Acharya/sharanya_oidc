trigger:
- main

pool:
  vmImage: ubuntu-latest

steps:
# 1. The Handshake: This generates the token
# Ensure 'MyServiceConnection' is your actual service connection name
- task: JfrogCliV2@1
  name: jfStep
  inputs:
    jfrogPlatformConnection: 'MyServiceConnection'
    command: 'jf rt ping'

# 2. The Correct Download Step
- script: |
    echo "Downloading hi.sh from Artifactory..."
    
    # We map the token to an environment variable 'TOKEN'
    # Use quotes to ensure the shell treats it as a single string
    TOKEN="$(jfStep.oidc_token)"
    URL="https://hts2.jfrog.io/artifactory/sharanya-oidc/hi.sh"
    
    # Execute curl with the Bearer token
    curl -H "Authorization: Bearer $TOKEN" \
         -L "$URL" \
         --output hi.sh
         
    echo "Download process finished."
  displayName: 'Download File with Curl (OIDC)'

# 3. Verification Step
- script: |
    if [ -f hi.sh ]; then
      echo "Success! File hi.sh found."
      echo "--- File Content Start ---"
      cat hi.sh
      echo "--- File Content End ---"
      
      # Fail the pipeline if the file is just a JSON error message
      if grep -q "errors" hi.sh; then
        echo "##vso[task.logissue type=error]Artifactory returned an error. Check permissions!"
        exit 1
      fi
    else
      echo "##vso[task.logissue type=error]File hi.sh was never created."
      exit 1
    fi
  displayName: 'Verify Downloaded Content'